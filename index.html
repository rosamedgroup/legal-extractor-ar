<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مستخرج القضايا القانونية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .prose {
            max-width: 100%;
        }
        .prose h3 {
            margin-top: 1.25em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }
         .prose p, .prose li {
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">مستخرج القضايا القانونية</h1>
                <p class="mt-2 text-lg text-gray-600">أدخل رابطاً من قاعدة بيانات وزارة العدل لاستخراج وتنظيم معلوماته القانونية باستخدام الذكاء الاصطناعي.</p>
            </div>

            <!-- Input Section -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="url" id="urlInput" placeholder="الصق الرابط من ملف molurls.jason هنا..." class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm">
                    <button id="extractBtn" class="w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all disabled:bg-indigo-300">
                        <svg id="button-icon" class="w-5 h-5 ml-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c.3 0 .6.1.8.4l.7.7c.2.3.4.6.4.9s-.1.6-.4.8l-2.3 2.3c-.3.2-.6.4-.9.4s-.6-.1-.8-.4l-.7-.7c-.2-.3-.4-.6-.4-.9s.1-.6.4-.8l2.3-2.3c.2-.3.5-.4.8-.4zM5 5c.3 0 .6.1.8.4l.7.7c.2.3.4.6.4.9s-.1.6-.4.8l-2.3 2.3c-.3.2-.6.4-.9.4s-.6-.1-.8-.4l-.7-.7c-.2-.3-.4-.6-.4-.9s.1-.6.4-.8l2.3-2.3C4.4 5.1 4.7 5 5 5zM12 15c.3 0 .6.1.8.4l.7.7c.2.3.4.6.4.9s-.1.6-.4.8l-2.3 2.3c-.3.2-.6.4-.9.4s-.6-.1-.8-.4l-.7-.7c-.2-.3-.4-.6-.4-.9s.1-.6.4-.8l2.3-2.3c.2-.3.5-.4.8-.4z"></path><path d="M20 12c0 .3-.1.6-.4.8l-.7.7c-.3.2-.6.4-.9.4s-.6-.1-.8-.4l-2.3-2.3c-.2-.3-.4-.6-.4-.9s.1-.6.4-.8l.7-.7c.3-.2.6-.4.9-.4s.6.1.8.4l2.3 2.3c.3.2.4.5.4.8zM9.5 9.5c0 .3-.1.6-.4.8l-.7.7c-.3.2-.6.4-.9.4s-.6-.1-.8-.4L4.4 8.6c-.2-.3-.4-.6-.4-.9s.1-.6.4-.8l.7-.7c.3-.2.6-.4.9-.4s.6.1.8.4l2.3 2.3c.2.3.4.5.4.8zM14.5 14.5c0 .3-.1.6-.4.8l-.7.7c-.3.2-.6.4-.9.4s-.6-.1-.8-.4l-2.3-2.3c-.2-.3-.4-.6-.4-.9s.1-.6.4-.8l.7-.7c.3-.2.6-.4.9-.4s.6.1.8.4l2.3 2.3c.2.3.4.5.4.8z"></path></svg>
                        <span id="button-text">جلب وتحليل القضية</span>
                    </button>
                </div>
            </div>

            <!-- Output Section -->
            <div id="outputContainer" class="hidden">
                <div id="loadingState" class="text-center p-10 bg-white rounded-2xl shadow-lg">
                    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto"></div>
                    <p class="mt-6 text-gray-600 text-lg">جاري تحليل الرابط وتنظيم البيانات القانونية... يرجى الانتظار.</p>
                </div>
                <div id="errorState" class="hidden text-center p-10 bg-red-50 border-l-4 border-red-400 rounded-r-lg">
                     <h3 class="text-lg font-medium text-red-800">فشل التحليل</h3>
                     <p id="errorMessage" class="mt-2 text-sm text-red-700"></p>
                </div>
                <div id="resultsState" class="hidden bg-white rounded-2xl shadow-lg p-6 md:p-8 prose">
                    <!-- Results will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlInput = document.getElementById('urlInput');
            const extractBtn = document.getElementById('extractBtn');
            const outputContainer = document.getElementById('outputContainer');
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const errorMessage = document.getElementById('errorMessage');
            const resultsState = document.getElementById('resultsState');
            const buttonIcon = document.getElementById('button-icon');
            const buttonText = document.getElementById('button-text');

            const setButtonLoading = (isLoading) => {
                extractBtn.disabled = isLoading;
                if (isLoading) {
                    buttonIcon.classList.add('animate-spin');
                    buttonText.textContent = 'جاري التحليل...';
                } else {
                    buttonIcon.classList.remove('animate-spin');
                    buttonText.textContent = 'جلب وتحليل القضية';
                }
            };

            const displayError = (message) => {
                loadingState.classList.add('hidden');
                resultsState.classList.add('hidden');
                errorMessage.textContent = message;
                errorState.classList.remove('hidden');
            };

            const displayResults = (data) => {
                loadingState.classList.add('hidden');
                errorState.classList.add('hidden');
                
                let partiesHtml = '<ul>';
                if (data.الاطراف && data.الاطراف.length > 0) {
                    data.الاطراف.forEach(p => {
                        partiesHtml += `<li><strong>${p.الدور || 'طرف'}:</strong> ${p.الاسم || 'غير متوفر'} (الممثل: ${p.الممثل || 'غير متوفر'})</li>`;
                    });
                } else {
                    partiesHtml += '<li>لا توجد معلومات عن الأطراف.</li>';
                }
                partiesHtml += '</ul>';

                let questionsHtml = '<ul>';
                 if (data.المسائل_القانونية_الرئيسية && data.المسائل_القانونية_الرئيسية.length > 0) {
                    data.المسائل_القانونية_الرئيسية.forEach(q => {
                        questionsHtml += `<li>${q}</li>`;
                    });
                } else {
                    questionsHtml += '<li>لم يتم تحديد مسائل قانونية رئيسية.</li>';
                }
                questionsHtml += '</ul>';

                resultsState.innerHTML = `
                    <div style="padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.75rem;">
                        <h2 style="margin-top: 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">ملخص القضية</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div><strong>رقم الحكم:</strong><br>${data.رقم_الحكم || 'غير متوفر'}</div>
                            <div><strong>تاريخ الإصدار:</strong><br>${data.تاريخ_الاصدار || 'غير متوفر'}</div>
                            <div><strong>نوع القضية:</strong><br>${data.نوع_القضية || 'غير متوفر'}</div>
                            <div><strong>التصنيف:</strong><br>${data.التصنيف || 'غير متوفر'}</div>
                            <div style="grid-column: 1 / -1;"><strong>المحكمة المصدرة:</strong><br>${data.المحكمة_المصدرة || 'غير متوفر'}</div>
                        </div>
                    </div>

                    <h3>الأطراف المعنية</h3>
                    ${partiesHtml}

                    <h3>ملخص الوقائع</h3>
                    <p>${data.ملخص_الوقائع || 'لا يوجد ملخص متوفر.'}</p>

                    <h3>المسائل القانونية الرئيسية</h3>
                    ${questionsHtml}

                    <h3>الأساس القضائي للحكم</h3>
                    <p>${data.الاساس_القضائي || 'لم يتم تقديم أساس قضائي.'}</p>

                    <h3>نص الحكم الكامل</h3>
                    <p>${data.نص_الحكم || 'لم يتم تقديم نص الحكم.'}</p>
                `;
                resultsState.classList.remove('hidden');
            };

            async function callGeminiAPI(prompt) {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        "رقم_الحكم": { "type": "STRING" },
                        "تاريخ_الاصدار": { "type": "STRING" },
                        "نوع_القضية": { "type": "STRING" },
                        "التصنيف": { "type": "STRING" },
                        "المحكمة_المصدرة": { "type": "STRING" },
                        "الاطراف": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "الدور": { "type": "STRING" },
                                    "الاسم": { "type": "STRING" },
                                    "الممثل": { "type": "STRING" }
                                }
                            }
                        },
                        "ملخص_الوقائع": { "type": "STRING" },
                        "المسائل_القانونية_الرئيسية": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "الاساس_القضائي": { "type": "STRING" },
                        "نص_الحكم": { "type": "STRING" }
                    }
                };
                
                const payload = { 
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                };
                
                const apiUrl = '/api/gemini-ar';

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`فشلت استجابة الواجهة البرمجية بحالة ${response.status}. تحقق من الكونسول.`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        return JSON.parse(jsonText);
                    } else {
                        throw new Error("استجابة غير صالحة أو فارغة من الواجهة البرمجية.");
                    }
                } catch (error) {
                    console.error("API Call Error:", error);
                    throw error;
                }
            }

            extractBtn.addEventListener('click', async () => {
                const url = urlInput.value;
                if (!url) {
                    alert('الرجاء إدخال رابط.');
                    return;
                }
                
                outputContainer.classList.remove('hidden');
                loadingState.classList.remove('hidden');
                errorState.classList.add('hidden');
                resultsState.classList.add('hidden');
                setButtonLoading(true);

                const prompt = `أنت مساعد قانوني. سأزودك برابط لقرار قضائي من وزارة العدل السعودية. لا يمكنك الوصول إلى الرابط، لكني أريدك أن تنشئ ملخصًا واقعيًا لقضية قانونية وهمية بناءً على بنية هذا الرابط: ${url}. استخرج ونظم المعلومات بالتنسيق المحدد في JSON. قم بإنشاء تفاصيل معقولة ولكن خيالية لكل حقل تكون مناسبة لسياق القانون السعودي. على سبيل المثال، لقضية تجارية، اخترع تفاصيل حول نزاع عقد. لقضية أحوال شخصية، اخترع تفاصيل حول قضية ميراث. اجعل تاريخ الإصدار تاريخًا حديثًا ومعقولاً.`;

                try {
                    const structuredData = await callGeminiAPI(prompt);
                    displayResults(structuredData);
                } catch (e) {
                    displayError(e.message || 'حدث خطأ غير معروف.');
                } finally {
                    setButtonLoading(false);
                }
            });
        });
    </script>

</body>
</html>